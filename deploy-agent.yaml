- name: Deploy Agents
  hosts: all
  remote_user: pi
  become: true
  vars:
    OP_CONNECT_TOKEN: "{{ lookup('ansible.builtin.env', 'OP_CONNECT_TOKEN') }}"
    OP_CONNECT_HOST: "{{ lookup('ansible.builtin.env', 'OP_CONNECT_HOST') }}"
  tasks:
  - name: Make directory
    file:
      path: /usr/local/src/pi-sensor-agent/
      state: directory
  - name: Write 1password env file
    ansible.builtin.template:
      src: ./agent/deployment/op-env.j2
      dest: /usr/local/src/pi-sensor-agent/.op-env
      owner: root
      group: root
    no_log: True
  - name: Write service env-file template
    ansible.builtin.copy:
      src: ./agent/deployment/env-file.tmpl
      dest: /usr/local/src/pi-sensor-agent/.env-file.tmpl
      owner: root
      group: root
      force: yes
  - name: Copy agent systemd unit file
    ansible.builtin.copy:
      src: ./agent/deployment/systemd-unit.service
      dest: /etc/systemd/system/test-pi-sensor-agent.service
      owner: root
      group: root
      force: yes
  - name: Copy agent binary
    ansible.builtin.copy:
      src: ./build/pi-sensor-agent
      dest: /usr/local/src/pi-sensor-agent/pi-sensor-agent
      mode: '0755'
      owner: pi
      group: pi
      force: yes
# daemon reload
# systemctl restart
